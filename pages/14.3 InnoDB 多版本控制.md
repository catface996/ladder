title:: 14.3 InnoDB 多版本控制

- InnoDB 是一个多版本存储引擎。它保存有关已更改行的旧版本的信息，以支持并发和回滚等事务特性。此信息存储在称为回滚段的数据结构中的系统表空间或撤消表空间中。请参阅第14.6.3.4节“撤销表空间”。InnoDB 使用回滚段中的信息来执行事务回滚中所需的撤销操作。它还使用这些信息构建行的早期版本，以实现一致的读取。参见14.7.2.3节，“一致的非锁定读取”。
- 在内部，InnoDB 为存储在数据库中的每一行添加三个字段:
	- 一个6字节的 db_trx _ id 字段表示插入或更新行的最后一个事务的事务标识符。此外，删除在内部被视为更新，其中行中的一个特殊位被设置为将其标记为 deleted。
	- 一个7字节的 db_roll _ ptr 字段称为滚动指针。滚动指针指向写入回滚段的撤消日志记录。如果更新了行，则撤消日志记录包含在更新行之前重新生成其内容所必需的信息。
	- 一个6字节的 db_row _ ID 字段包含一个行 ID，该行 ID 随着插入新行而单调增加。如果 InnoDB 自动生成聚集索引，则索引包含行 ID 值。否则，db_row _ id 列不会出现在任何索引中。
- 回滚段中的撤销日志分为插入和更新撤销日志。只有在事务回滚中才需要插入撤消日志，并且一旦事务提交就可以被丢弃。更新撤销日志也用于一致的读取，但是只有在没有事务存在时，InnoDB 才会为其分配一个快照，一致读取时可能需要更新撤销日志中的信息来构建一个早期版本的数据库行时，更新撤销日志才会被丢弃。有关撤消日志的其他信息，请参阅第14.6.7节“撤消日志”。
- 建议您定期提交事务，包括只发出一致读操作的事务。否则，InnoDB 不能丢弃更新撤消日志中的数据，回滚段可能会变得太大，占用驻留它的表空间。有关管理撤销表空间的信息，请参阅第14.6.3.4节“撤销表空间”。
- 回滚段中的撤消日志记录的物理大小通常小于对应的插入或更新行。您可以使用此信息计算回滚段所需的空间。
- 在 InnoDB 多版本控制方案中，当您使用 SQL 语句删除数据库中的行时，该行不会立即从数据库中物理删除。InnoDB 只有在丢弃为删除而写入的更新撤销日志记录时，才会物理删除相应的行及其索引记录。这种删除操作称为清除，它非常快，通常与执行删除操作的 SQL 语句的时间顺序相同。
- 如果以表中大致相同的速度小批量地插入和删除行，那么清除线程可能会开始滞后，而且由于所有的“死”行，表可能会变得越来越大，从而使所有内容都受到磁盘限制，而且速度非常慢。在这种情况下，调整 innodb _ max _ purge _ lag 系统变量来抑制新的行操作，并为清洗线程分配更多的资源。有关更多信息，请参见14.8.10节“清除配置”。
- ## 多版本和二级索引
	- InnoDB 多版本并发控制(MVCC)对待二级索引的方式与聚集索引不同。聚集索引中的记录就地更新，其隐藏的系统列指向撤消日志项，可以从中重新构建早期版本的记录。与聚集索引记录不同，辅助索引记录不包含隐藏的系统列，也不会就地更新。
	- 当更新辅助索引列时，旧的辅助索引记录将被删除标记，插入新记录，并最终清除被删除标记的记录。当二级索引记录被删除或者二级索引页面被更新的事务更新时，InnoDB 在聚集索引中查找数据库记录。在聚集索引中，检查记录的 DB _ trx _ id，如果在读取事务启动后修改了记录，则从撤销日志中检索记录的正确版本。
	- 如果二级索引记录被标记为删除，或者二级索引页被更新的事务更新，则不使用覆盖索引技术。InnoDB 不从索引结构返回值，而是在聚集索引中查找记录。
	- 但是，如果启用了索引条件下推( [[ICP]] )优化，并且 WHERE 条件的某些部分可以仅使用索引字段进行评估，则 MySQL 服务器仍将 WHERE 条件的这一部分下推到存储引擎，在存储引擎中使用索引进行评估。如果没有找到匹配的记录，则避免聚集索引查找。如果找到匹配的记录，即使是在删除标记的记录之间，InnoDB 也会在聚集索引中查找该记录。
-
-
-
-