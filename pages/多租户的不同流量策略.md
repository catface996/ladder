- 目标
	- 实现应用级的租户隔离。
	- 针对不同级别的租户做不同的流量策略。
- 抛砖引玉
	- 横向流量的服务治理：
		- 如何实现网格内服务之间不同 RPC 版本的治理，即东西流量治理。
	- 数据层面的组合隔离：
		- 数据层面的租户隔离，例如 [MyBatis-plus](https://baomidou.com/pages/aef2f2/#tenantlineinnerinterceptor)
		- 线程级别，无法通过 RPC 跨微服务。
		- 只是针对数据隔离，仍旧使用同一个或者同一组的应用，使用同一个数据库。
- 期望的流量拓扑
	- ![image.png](../assets/image_1651637350850_0.png)
- 代码和配置介绍
	- spring cloud gateway 实现的业务网关介绍
		- 源码地址
			- github： https://github.com/catface996/ladder
			- gitee： https://gitee.com/catface996/ladder
		- token 换取 userId
		- 根据 userId 决策gray、prod
		- 根据 userId 决策 L1，L2，L3
	- Deployment 配置介绍
	- Service 配置介绍
	- istio-gateway 配置介绍
	- Destination Rule 配置介绍
	- Virtual Service 配置介绍
- 实施步骤和验证
	- 部署 Deployment
		- 执行部署命令
			- ```shell
			  ## 部署命令，在 ladder/code/istio/lessee 目录下执行
			  kubectl apply -f deployment.yaml
			  ```
		- 查验部署结果
			- kiali 查看 Workload 列表
				- ![image.png](../assets/image_1651651655164_0.png)
			- kiali 查看 Workload 日志
				- ![image.png](../assets/image_1651651677989_0.png)
				- ![image.png](../assets/image_1651651701716_0.png)
	- 部署 Service
		- 执行部署命令
			- ```shell
			  ## 部署命令，在 ladder/code/istio/lessee 目录下执行
			  kubectl apply -f service.yaml
			  ```
		- 查看 kiali 面板中的 Service 列表
			- ![image.png](../assets/image_1651651923680_0.png)
	- 部署 istio-gateway
		- 执行部署命令
			- ```shell
			  ## 部署命令，在 ladder/code/istio/lessee 目录下执行
			  kubectl apply -f biz-gateway-vs-bind-gateway.yaml
			  ```
		- 查验部署结果
			- kiali 查看 Istio Config 中的 Gateway 和 VirtualService
				- ![image.png](../assets/image_1651651991675_0.png)
	- 配置本地 hosts
		- 配置
			- ![image.png](../assets/image_1651652017947_0.png)
		- ping gateway.catface996.com 验证配置
			- ![image.png](../assets/image_1651652052484_0.png)
	- 访问 sayHello 接口
		- 执行 curl 访问
			- ```shell
			  curl http://gateway.catface996.com:31606/cat/sayHello
			  
			  ## 实际执行结果
			  ➜  ~ curl http://gateway.catface996.com:31606/cat/sayHello
			  TraceId: 08776c4fc59a5a7d361c973ad591f906  header env(null),lessee(null), I'm cat(L3) --> TraceId: 08776c4fc59a5a7d361c973ad591f906  header env(null),lessee(null), I'm dog(default) --> %
			  ➜  ~ curl http://gateway.catface996.com:31606/cat/sayHello
			  TraceId: ff614908b4841c080752a8eb2a00acbe  header env(null),lessee(null), I'm cat(L2) --> TraceId: ff614908b4841c080752a8eb2a00acbe  header env(null),lessee(null), I'm dog(L1) --> %
			  ➜  ~ curl http://gateway.catface996.com:31606/cat/sayHello
			  TraceId: cb3f2d7c4cc3c9b13748ff202799385f  header env(null),lessee(null), I'm cat(L1) --> TraceId: cb3f2d7c4cc3c9b13748ff202799385f  header env(null),lessee(null), I'm dog(L1) --> %
			  ```
		- 查看 kiali 中的流量图
			- ![image.png](../assets/image_1651653326705_0.png)
		- 查看 kiali 中的 Workload 日志
			- spring-cloud-gateway 日志
			- cat-dp-L1 日志
			- cat-dp-L2 日志
			- cat-dp-L3 日志
			- 查看链路追踪
	- 部署 Destination Rule
		- 执行部署命令
			- ```shell
			  ## 部署命令，在 ladder/code/istio/lessee 目录下执行
			  
			  ```
		- kiali 面板中查看 Destination Rule
			-
	- 部署 Virtual Service
		- 执行部署命令
			- ```shell
			  ## 部署命令，在 ladder/code/istio/lessee 目录下执行
			  
			  ```
		- 查看 kiali 面板中的 Virtual Service
	- 分别验证 L1，L2，L3 的流量分布及策略
		- 验证 L1
			- ```shell
			  ## 验证L1
			  ```
		- 验证 L2
		- 验证 L3
- 总结
	- 在集群入口处，部署业务网关，将根据业务参数设置的路由规则转换成 Istio 路由规则的入参，例如：http 请求 header 中的参数。
		- PS：在实际的工作中，除用户主动发起的同步请求外，还有基于用户请求衍生的异步线程，以及触发的消息，还有定时任务为起点的业务链路的路由参数生成策略等。
	- 转换后的通用协议层的路由参数需在整个业务链路中进行传播。